generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                String           @id @default(uuid())
  email             String           @unique
  password_hash     String
  name              String
  created_at        DateTime         @default(now())
  updated_at        DateTime         @updatedAt
  role              UserRole         @default(USER)
  couple_as_a       Couple?          @relation("UserA")
  couple_as_b       Couple?          @relation("UserB")
  transactions_paid Transaction[]    @relation("PaidBy")
  game_profile      UserGameProfile?

  @@map("users")
  installment_templates InstallmentTemplate[]
}

model UserGameProfile {
  id               String            @id @default(uuid())
  user_id          String            @unique
  current_xp       Int               @default(0)
  total_xp         Int               @default(0)
  level            Int               @default(1)
  current_streak   Int               @default(0)
  longest_streak   Int               @default(0)
  last_activity_at DateTime          @default(now())
  created_at       DateTime          @default(now())
  updated_at       DateTime          @updatedAt
  achievements     UserAchievement[]
  user             User              @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@map("user_game_profiles")
}

model Achievement {
  id                String            @id @default(uuid())
  key               String            @unique
  name              String
  description       String
  icon              String
  xp_reward         Int               @default(0)
  category          String
  created_at        DateTime          @default(now())
  user_achievements UserAchievement[]

  @@map("achievements")
}

model UserAchievement {
  id             String          @id @default(uuid())
  user_id        String
  achievement_id String
  achieved_at    DateTime        @default(now())
  achievement    Achievement     @relation(fields: [achievement_id], references: [id], onDelete: Cascade)
  profile        UserGameProfile @relation(fields: [user_id], references: [user_id], onDelete: Cascade)

  @@unique([user_id, achievement_id])
  @@index([user_id])
  @@index([achievement_id])
  @@map("user_achievements")
}

model Couple {
  id                              String                         @id @default(uuid())
  user_id_a                       String                         @unique
  user_id_b                       String                         @unique
  free_spending_a_monthly         Decimal                        @default(0) @db.Decimal(10, 2)
  free_spending_b_monthly         Decimal                        @default(0) @db.Decimal(10, 2)
  free_spending_a_remaining       Decimal                        @default(0) @db.Decimal(10, 2)
  free_spending_b_remaining       Decimal                        @default(0) @db.Decimal(10, 2)
  reset_day                       Int                            @default(1)
  created_at                      DateTime                       @default(now())
  updated_at                      DateTime                       @updatedAt
  allow_personal_accounts         Boolean                        @default(true)
  allow_private_transactions      Boolean                        @default(true)
  financial_model                 FinancialModel                 @default(CUSTOM)
  accounts                        Account[]
  categories                      Category[]
  invites                         CoupleInvite?
  user_a                          User                           @relation("UserA", fields: [user_id_a], references: [id], onDelete: Cascade)
  user_b                          User                           @relation("UserB", fields: [user_id_b], references: [id], onDelete: Cascade)
  recurring_transaction_templates RecurringTransactionTemplate[]
  subscription                    Subscription?
  transactions                    Transaction[]
  installment_templates InstallmentTemplate[]

  @@map("couples")
}

model CoupleInvite {
  id            String             @id @default(uuid())
  inviter_id    String
  invitee_name  String
  invitee_email String
  token         String             @unique
  status        CoupleInviteStatus @default(PENDING)
  couple_id     String?            @unique
  expires_at    DateTime
  created_at    DateTime           @default(now())
  accepted_at   DateTime?
  couple        Couple?            @relation(fields: [couple_id], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([inviter_id])
  @@index([invitee_email])
  @@map("couple_invites")
}

model Plan {
  id                     String         @id @default(uuid())
  name                   String         @unique
  price_monthly          Decimal        @db.Decimal(10, 2)
  max_accounts           Int            @default(5)
  max_transactions_month Int            @default(100)
  features               Json
  created_at             DateTime       @default(now())
  subscriptions          Subscription[]

  @@map("plans")
}

model Subscription {
  id                     String             @id @default(uuid())
  couple_id              String             @unique
  plan_id                String
  status                 SubscriptionStatus @default(TRIAL)
  start_date             DateTime           @default(now())
  end_date               DateTime?
  created_at             DateTime           @default(now())
  updated_at             DateTime           @updatedAt
  stripe_customer_id     String?            @unique
  stripe_price_id        String?
  stripe_subscription_id String?            @unique
  couple                 Couple             @relation(fields: [couple_id], references: [id], onDelete: Cascade)
  plan                   Plan               @relation(fields: [plan_id], references: [id])

  @@map("subscriptions")
}

model Account {
  id              String        @id @default(uuid())
  couple_id       String
  owner_id        String?
  name            String
  type            AccountType   @default(CHECKING)
  current_balance Decimal       @default(0) @db.Decimal(10, 2)
  created_at      DateTime      @default(now())
  updated_at      DateTime      @updatedAt
  couple          Couple        @relation(fields: [couple_id], references: [id], onDelete: Cascade)
  transactions    Transaction[]
  installment_templates InstallmentTemplate[]

  @@index([couple_id])
  @@map("accounts")
}

model Category {
  id           String           @id @default(uuid())
  couple_id    String
  name         String
  icon         String           @default("Circle")
  color        String           @default("#6b7280")
  type         TransactionType?
  is_default   Boolean          @default(false)
  created_at   DateTime         @default(now())
  updated_at   DateTime         @updatedAt
  couple       Couple           @relation(fields: [couple_id], references: [id], onDelete: Cascade)
  transactions Transaction[]
  installment_templates InstallmentTemplate[]

  @@index([couple_id])
  @@map("categories")
}

model Transaction {
  id                    String                        @id @default(uuid())
  couple_id             String
  type                  TransactionType
  amount                Decimal                       @db.Decimal(10, 2)
  description           String?
  paid_by_id            String
  account_id            String
  is_couple_expense     Boolean                       @default(false)
  is_free_spending      Boolean                       @default(false)
  transaction_date      DateTime                      @default(now())
  created_at            DateTime                      @default(now())
  category_id           String?
  visibility            TransactionVisibility         @default(SHARED)
  installment_group_id  String?
  installment_number    Int?
  recurring_template_id String?
  total_installments    Int?
  account               Account                       @relation(fields: [account_id], references: [id])
  category              Category?                     @relation(fields: [category_id], references: [id])
  couple                Couple                        @relation(fields: [couple_id], references: [id], onDelete: Cascade)
  paid_by               User                          @relation("PaidBy", fields: [paid_by_id], references: [id])
  recurring_occurrences RecurringOccurrence[]
  installments Installment[]
  recurring_template    RecurringTransactionTemplate? @relation(fields: [recurring_template_id], references: [id])

  @@index([couple_id])
  @@index([paid_by_id])
  @@index([transaction_date])
  @@index([category_id])
  @@index([installment_group_id])
  @@index([recurring_template_id])
  @@map("transactions")
}

model RecurringTransactionTemplate {
  id                String                @id @default(uuid())
  couple_id         String
  type              TransactionType
  amount            Decimal               @db.Decimal(10, 2)
  description       String?
  paid_by_id        String
  account_id        String
  is_couple_expense Boolean               @default(false)
  is_free_spending  Boolean               @default(false)
  visibility        TransactionVisibility @default(SHARED)
  category_id       String?
  frequency         RecurrenceFrequency
  interval          Int                   @default(1)
  start_date        DateTime
  end_date          DateTime?
  next_occurrence   DateTime
  is_active         Boolean               @default(true)
  created_at        DateTime              @default(now())
  updated_at        DateTime              @updatedAt
  occurrences RecurringOccurrence[]
  couple            Couple                @relation(fields: [couple_id], references: [id], onDelete: Cascade)
  transactions      Transaction[]

  @@index([couple_id])
  @@index([next_occurrence])
  @@index([is_active])
  @@map("recurring_transaction_templates")
}

enum CoupleInviteStatus {
  PENDING
  ACCEPTED
  EXPIRED
  CANCELED
}

enum SubscriptionStatus {
  ACTIVE
  TRIAL
  CANCELED
  EXPIRED
}

enum AccountType {
  CHECKING
  SAVINGS
  INVESTMENT
  CASH
  CREDIT_CARD
}

enum TransactionType {
  INCOME
  EXPENSE
}

enum TransactionVisibility {
  SHARED
  FREE_SPENDING
  PRIVATE
}

enum RecurrenceFrequency {
  DAILY
  WEEKLY
  MONTHLY
  YEARLY
}

enum FinancialModel {
  TRANSPARENT
  AUTONOMOUS
  CUSTOM
}

enum UserRole {
  USER
  ADMIN
}

enum OccurrenceStatus {
  PENDING
  PAID
  SKIPPED
}

model RecurringOccurrence {
  id             String            @id @default(uuid()) 
  template_id    String            
  due_date       DateTime          @db.Timestamp(6)
  status         OccurrenceStatus  @default(PENDING)
  transaction_id String?           
  created_at     DateTime          @default(now()) @db.Timestamp(6)
  updated_at     DateTime          @updatedAt @db.Timestamp(6)

  template       RecurringTransactionTemplate @relation(fields: [template_id], references: [id], onDelete: Cascade)
  transaction    Transaction?                 @relation(fields: [transaction_id], references: [id], onDelete: SetNull)

  @@index([template_id])
  @@index([due_date])
  @@index([status])
  @@map("recurring_occurrences")
}

model InstallmentTemplate {
  id                  String                  @id @default(uuid()) 
  couple_id           String                  
  description         String?
  total_amount        Decimal                 @db.Decimal(10, 2)
  total_installments  Int
  paid_by_id          String                  
  account_id          String                  
  category_id         String?                 
  is_couple_expense   Boolean                 @default(false)
  is_free_spending    Boolean                 @default(false)
  visibility          TransactionVisibility
  first_due_date      DateTime                @db.Timestamp(6)
  is_active           Boolean                 @default(true)
  created_at          DateTime                @default(now()) @db.Timestamp(6)
  updated_at          DateTime                @updatedAt @db.Timestamp(6)

  couple              Couple                  @relation(fields: [couple_id], references: [id], onDelete: Cascade)
  paid_by             User                    @relation(fields: [paid_by_id], references: [id])
  account             Account                 @relation(fields: [account_id], references: [id])
  category            Category?               @relation(fields: [category_id], references: [id])
  installments        Installment[]

  @@index([couple_id])
  @@index([is_active])
  @@map("installment_templates")
}

model Installment {
  id                  String                  @id @default(uuid()) 
  template_id         String                  
  installment_number  Int
  amount              Decimal                 @db.Decimal(10, 2)
  due_date            DateTime                @db.Timestamp(6)
  status              OccurrenceStatus        @default(PENDING)
  transaction_id      String?                 
  created_at          DateTime                @default(now()) @db.Timestamp(6)
  updated_at          DateTime                @updatedAt @db.Timestamp(6)

  template            InstallmentTemplate     @relation(fields: [template_id], references: [id], onDelete: Cascade)
  transaction         Transaction?            @relation(fields: [transaction_id], references: [id], onDelete: SetNull)

  @@unique([template_id, installment_number])
  @@index([template_id])
  @@index([due_date])
  @@index([status])
  @@map("installments")
}
